---
- name: Scan disks on Windows servers and generate a report
  hosts: windows_servers
  gather_facts: no
  tasks:
    - name: Gather disk facts from Windows servers
      community.windows.win_disk_facts:
      register: disk_facts

    - name: Filter disks with free space â‰¤ 10GB
      set_fact:
        low_free_space_disks: >-
          {{
            low_free_space_disks | default([]) + [{
              'server_name': inventory_hostname,
              'disk_size_gb': (item.size / 1GB) | round(2),
              'free_space_gb': (item.size_remaining / 1GB) | round(2),
              'percentage_free': ((item.size_remaining / item.size) * 100) | round(2)
            }}]
          }}
      loop: "{{ disk_facts.disks }}"
      when: (item.size_remaining / 1GB) <= 10

- name: Generate HTML report and send email
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Generate HTML report
      set_fact:
        html_report: >-
          <html>
            <head>
              <style>
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid black; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
              </style>
            </head>
            <body>
              <h2>Low Disk Space Report</h2>
              <table>
                <tr>
                  <th>Server Name</th>
                  <th>Disk Size (GB)</th>
                  <th>Free Space (GB)</th>
                  <th>Percentage Free</th>
                </tr>
                {% for server in hostvars %}
                  {% if hostvars[server].low_free_space_disks is defined %}
                    {% for disk in hostvars[server].low_free_space_disks %}
                      <tr>
                        <td>{{ disk.server_name }}</td>
                        <td>{{ disk.disk_size_gb }}</td>
                        <td>{{ disk.free_space_gb }}</td>
                        <td>{{ disk.percentage_free }}%</td>
                      </tr>
                    {% endfor %}
                  {% endif %}
                {% endfor %}
              </table>
            </body>
          </html>

    - name: Send email with the HTML report
      community.general.mail:
        host: "smtp.example.com"
        port: 587
        username: "your_email@example.com"
        password: "your_password"
        to: "recipient@example.com"
        subject: "Low Disk Space Report"
        body: "{{ html_report }}"
        subtype: html
