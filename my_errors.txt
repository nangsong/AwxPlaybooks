---
- name: Scan C drive on Windows servers and generate a report
  hosts: windows_servers
  gather_facts: no
  tasks:
    - name: Run PowerShell script to get C drive information
      ansible.windows.win_shell: |
        Get-WmiObject -Query "SELECT Size, FreeSpace FROM Win32_LogicalDisk WHERE DeviceID = 'C:'" |
        Select-Object @{Name='SizeGB'; Expression={[math]::Round($_.Size / 1GB, 2)}},
                      @{Name='FreeSpaceGB'; Expression={[math]::Round($_.FreeSpace / 1GB, 2)}},
                      @{Name='PercentageFree'; Expression={[math]::Round(($_.FreeSpace / $_.Size * 100), 2)}} |
        ConvertTo-Json
      register: disk_info

    - name: Parse PowerShell output
      set_fact:
        c_drive_info: "{{ disk_info.stdout | from_json }}"

    - name: Filter C drive with free space â‰¤ 10GB
      set_fact:
        low_free_space_disks: >-
          {{
            low_free_space_disks | default([]) + [{
              'server_name': inventory_hostname,
              'disk_size_gb': c_drive_info.SizeGB,
              'free_space_gb': c_drive_info.FreeSpaceGB,
              'percentage_free': c_drive_info.PercentageFree
            }}]
          }}
      when: c_drive_info.FreeSpaceGB <= 10

- name: Generate HTML report and send email
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Generate HTML report
      set_fact:
        html_report: >-
          <html>
            <head>
              <style>
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid black; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
              </style>
            </head>
            <body>
              <h2>Low Disk Space Report (C Drive)</h2>
              <table>
                <tr>
                  <th>Server Name</th>
                  <th>Disk Size (GB)</th>
                  <th>Free Space (GB)</th>
                  <th>Percentage Free</th>
                </tr>
                {% for server in hostvars %}
                  {% if hostvars[server].low_free_space_disks is defined %}
                    {% for disk in hostvars[server].low_free_space_disks %}
                      <tr>
                        <td>{{ disk.server_name }}</td>
                        <td>{{ disk.disk_size_gb }}</td>
                        <td>{{ disk.free_space_gb }}</td>
                        <td>{{ disk.percentage_free }}%</td>
                      </tr>
                    {% endfor %}
                  {% endif %}
                {% endfor %}
              </table>
            </body>
          </html>

    - name: Send email with the HTML report
      community.general.mail:
        host: "smtp.example.com"
        port: 587
        username: "your_email@example.com"
        password: "your_password"
        to: "recipient@example.com"
        subject: "Low Disk Space Report (C Drive)"
        body: "{{ html_report }}"
        subtype: html
