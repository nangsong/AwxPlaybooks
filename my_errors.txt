---
- name: Get last boot time from Windows servers
  win_shell: |
    $lastBootTime = (Get-CimInstance -ClassName Win32_OperatingSystem).LastBootUpTime
    [PSCustomObject]@{
      Server = $env:COMPUTERNAME
      LastBootTime = $lastBootTime.ToString("yyyy-MM-dd HH:mm:ss")
      UptimeDays = [math]::Round((New-TimeSpan -Start $lastBootTime -End (Get-Date)).TotalDays)
    } | ConvertTo-Json
  register: boot_time

- name: Parse Powershell Output
  set_fact:
    boot_info: "{{ boot_time.stdout | from_json }}"

- name: Parse JSON output
  set_fact:
    server_data: >-
      {{
        server_data | default([]) + [{
          'Server': boot_info.Server,
          'LastBootTime': boot_info.LastBootTime,
          'UptimeDays': boot_info.UptimeDays
        }]
      }}
  when: boot_time.stdout is defined and boot_info.UptimeDays >= uptime_threshold

- name: Calculate total number of servers
  set_fact:
    server_count: >-
      {{
        (hostvars | dict2items | selectattr('value.server_data', 'defined') | map(attribute='value.server_data') | flatten | length)
      }}
  delegate_to: localhost
  run_once: yes

- name: Create HTML table
  set_fact:
    email_body: >-
      <html>
      <head>
        <style>
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid black; padding: 8px; text-align: left; }
            th { background-color:#288efc; }
          </style>
      </head>
      <body>
      <h2>Windows Servers Uptime Report (>= {{ uptime_threshold }} Days)</h2>
      <p><strong>Total Number of Servers: {{ server_count | default(0) }}</strong></p>
      <table border="1" cellpadding="5" cellspacing="0">
      <tr>
        <th>Server</th>
        <th>Last Boot Time</th>
        <th>Uptime (Days)</th>
      </tr>
      {% for server in hostvars %}
        {% if hostvars[server].server_data is defined %}
          {% for b_info in hostvars[server].server_data %}
            <tr>
              <td>{{ b_info.Server }}</td>
              <td>{{ b_info.LastBootTime }}</td>
              <td>{{ b_info.UptimeDays }}</td>
            </tr>
          {% endfor %}
        {% endif%}
      {% endfor %}
      </table>
      <p style="font-size: 12px; color: #999; text-align: center;">This report was generated automatically by Windows Team.</p>
      </body>
      </html>
  delegate_to: localhost
  run_once: yes

- name: Send HTML report via email
  delegate_to: localhost
  run_once: yes
  community.general.mail:
    host: "{{ smtp_server }}"
    port: "{{ smtp_port }}"
    username: "{{ smtp_username }}"
    password: "{{ smtp_password }}"
    to: "{{ email_to }}"
    subject: "Windows Servers Uptime Report (>= {{ uptime_threshold }} Days)"
    body: "{{ email_body }}"
    subtype: html
  when: server_count is defined and server_count > 0
