- name: Execute PowerShell script to gather cluster health data
  win_shell: |
    $ErrorActionPreference = "Stop"
    try {
      $clusterObj = Get-Cluster -Cluster $env:COMPUTERNAME -ErrorAction Stop
      $clusterName = $clusterObj.Name
      $resources = Get-ClusterResource -Cluster $clusterName -ErrorAction Stop | 
                   Select-Object Name, State, OwnerGroup, LastFailoverTime
      
      $output = @()
      foreach ($resource in $resources) {
        $output += @{
          ClusterName  = "$clusterName"
          Node         = "$env:COMPUTERNAME"
          ResourceName = "$($resource.Name)"
          Status       = "$($resource.State)"
          OwnerGroup   = "$($resource.OwnerGroup)"
          LastFailover = "$($resource.LastFailoverTime)"
        }
      }
      $output | ConvertTo-Json -Compress
    } catch {
      @{
        ClusterName  = "Unknown"
        Node         = "$env:COMPUTERNAME"
        ResourceName = "Error"
        Status       = "Failed"
        OwnerGroup   = "N/A"
        LastFailover = "N/A"
      } | ConvertTo-Json -Compress
    }
  args:
    executable: powershell.exe
  register: cluster_health_data
