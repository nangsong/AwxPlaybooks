---
- name: Windows Disk Health Check
  hosts: windows
  gather_facts: no

  tasks:
  - name: Get C drive disk information
    ansible.windows.win_shell: |
      Get-PSDrive C | Select-Object Used,Free,@{Name='TotalSize';Expression={($_.Used + $_.Free)}},@{Name='PercentFree';Expression={if($_.Used -ne 0) { [math]::Round(($_.Free / ($_.Used + $_.Free) * 100),2)} else {0}}}
    register: disk_info

  - name: Check if C drive usage is above 80%
    ansible.builtin.set_fact:
      high_usage: "{{ disk_info.stdout_lines[0].PercentFree | float < 20.0 }}"
  
  - name: Find files over 250MB on C drive
    ansible.windows.win_shell: |
      Get-ChildItem C:\ -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Length -gt 262144000 } | Select-Object FullName, @{Name="SizeInMB";Expression={"{0:N2}" -f ($_.Length / 1MB)}}
    register: large_files
    when: high_usage
    ignore_errors: yes

  - name: Generate report if usage is more than 80%
  ansible.builtin.template:
    src: disk_report.j2
    dest: "\\\\DC\\MyShared\\{{ inventory_hostname }}_disk_report.txt"
  when: high_usage

